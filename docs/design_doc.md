## **Claude Code モバイルクライアント 設計提案書**

> **実装状況**: Phase 1 (基盤構築) 完了 ✅  
> **現在**: Phase 2 (SSH統合) 準備中 🚧

### 1. 概要

本ドキュメントは、リモートサーバー上で動作する`claude code`と対話するための、モバイルクライアントアプリケーションの設計を定義するものです。

開発は**TypeScript + React Native + Expo**で行い、`claude code`の特性に合わせた最適化を行います。

#### 実装進捗
- ✅ **基盤**: React Native + Expo + TypeScript プロジェクト構築
- ✅ **状態管理**: Redux Toolkit による認証・セッション状態管理
- ✅ **UI/UX**: React Native Paper による Material Design 実装
- ✅ **画面構成**: サーバー接続、セッション管理、ターミナル、設定画面
- ✅ **SSH統合**: WebSocket経由で実装済み (`websocket-ssh.ts`)
- 🚧 **通知システム**: Expo Notifications 統合予定
- 🚧 **セキュリティ**: Expo Secure Store による認証情報暗号化予定

### 2. 背景と目的

`claude code`は強力な開発支援ツールですが、現在はデスクトップ環境での利用が主です。以下の目的を達成するため、モバイルクライアントを開発します。

* **リモートアクセスの提供:** スマートフォンから場所を問わず、リモートサーバー上の`claude code`セッションにアクセスし、タスクの指示や進捗確認を行えるようにする。
* **非同期ワークフローの実現:** `claude code`の作業が完了し、ユーザーの入力が必要になったタイミングで**Push通知**を送信することで、ユーザーは常にPC前で待機する必要がなくなります。
* **複数タスクの並行管理:** 複数の`claude code`セッションをシームレスに切り替え、複数のプロジェクトやタスクを並行して進められるようにする。

### 3. アーキテクチャ

#### 3.1. 技術スタック

参照プロジェクト () の構成はモダンで安定しているため、これを踏襲します。

| カテゴリ | 技術 | 理由 |
| :--- | :--- | :--- |
| **フレームワーク** | React Native + Expo (EAS Build) | 迅速なクロスプラットフォーム開発を実現するため。SSH接続などのネイティブ機能を利用するためにEAS(Expo Application Services)の使用を前提とします。 |
| **言語** | TypeScript | 型安全性による開発効率と品質の向上のため。 () |
| **状態管理** | Redux Toolkit | アプリケーション全体の複雑な状態（接続情報、セッションリスト、チャット履歴など）を予測可能かつ効率的に管理するため。 () |
| **画面遷移** | Expo Router | ファイルベースのルーティングにより、直感的で宣言的なナビゲーションを構築します。 () |
| **UIコンポーネント** | React Native Paper | Material Designに準拠した高品質なUIコンポーネント群により、迅速で一貫性のあるUI開発を実現します。 () |
| **API/SSH通信** | `websocket-ssh.ts` | コア機能であるSSH通信は、`src/api/websocket-ssh.ts` を使用し、バックエンドのWebSocketサーバー経由で行います。HTTP通信が必要な場合は`axios`を利用します。 |
| **データ永続化** | Expo Secure Store | サーバーURLや認証情報などの機密情報を安全にデバイス内に保存します。 () |
| **Push通知** | Expo Notifications | FCM (Firebase) / APNS (Apple) を利用したPush通知を容易に実装するため。 |

#### 3.2. アプリケーション構成（ディレクトリ構造）

参照プロジェクト () の構成を参考に、以下のようなディレクトリ構造を採用します。

```
/
├── app/                  # Expo Routerによる画面定義
│   ├── (tabs)/           # メイン機能のタブ画面
│   │   ├── _layout.tsx     # タブ自体のレイアウト
│   │   ├── session.tsx     # セッション管理画面
│   │   └── terminal.tsx    # ターミナル操作画面
│   ├── _layout.tsx       # 全体のルートレイアウト
│   ├── server-connection.tsx # サーバー接続画面
│   └── settings.tsx      # 設定画面
├── src/
│   ├── api/              # API・SSH通信関連のロジック
│   ├── components/       # 共通UIコンポーネント
│   ├── hooks/            # カスタムフック
│   ├── store/            # Redux状態管理 (authSlice, sessionSlice)
│   ├── theme/            # アプリのテーマ設定 ()
│   └── utils/            # ユーティリティ関数
└── ...                   # その他設定ファイル (package.json, app.json)
```

### 4. 主要機能と画面設計

#### 4.1. サーバー接続機能 ✅ 実装済み

* **目的:** ユーザーが管理するリモートサーバーへのSSH接続情報を設定・保存する。
* **実装状況:**
    * ✅ **UI実装**: `app/server-connection.tsx` に入力フォーム作成済み
    * ✅ **状態管理**: `src/store/authSlice.ts` に接続設定とエラーハンドリング実装
    * ✅ **バリデーション**: ホスト名、ポート、ユーザー名の入力検証
    * 🚧 **SSH接続**: 実際のSSH接続ロジック未実装
    * 🚧 **認証情報保存**: Expo Secure Store統合予定
* **次の作業:**
    * WebSocketによる接続確立と認証処理
    * 公開鍵認証の実装
    * 接続エラーハンドリングの強化

#### 4.2. セッション管理 ✅ 実装済み

* **目的:** サーバー上の複数の`claude code`セッションを管理し、切り替える。
* **実装状況:**
    * ✅ **UI実装**: `app/(tabs)/session.tsx` にセッション一覧とFAB作成済み
    * ✅ **状態管理**: `src/store/sessionSlice.ts` にセッション状態管理実装
    * ✅ **ナビゲーション**: セッション選択からターミナル画面への遷移
    * ✅ **tmuxコマンド**: WebSocket経由でのコマンド実行実装済み
    * 🚧 **セッション作成**: `tmux new -s <session_name> -d` 統合予定
    * 🚧 **セッション一覧**: `tmux ls` 結果パース未実装
* **次の作業:**
    * WebSocketメッセージプロトコル経由でのtmux操作
    * セッション作成・削除機能
    * リアルタイムセッション状態更新

#### 4.3. ターミナル/チャット画面 ✅ 実装済み

* **目的:** `claude code`との主要な対話を行う画面。
* **実装状況:**
    * ✅ **UI実装**: `app/(tabs)/terminal.tsx` にターミナルインターフェース作成済み
    * ✅ **入力機能**: コマンド入力フィールドと送信ボタン配置
    * ✅ **出力表示**: スクロール可能なターミナル出力表示（monospace）
    * ✅ **特殊キー**: Ctrl+C、Tab、矢印キーボタン実装
    * ✅ **セッション表示**: 現在のセッション情報表示
    * ✅ **リアルタイムI/O**: WebSocket経由でのstdout/stdin実装済み
    * 🚧 **コマンド履歴**: 上下矢印での履歴機能未実装
* **次の作業:**
    * WebSocket経由でのリアルタイム入出力
    * ターミナルエスケープシーケンス処理
    * コマンド履歴・自動補完機能

#### 4.4. Push通知 🚧 未実装

* **目的:** `claude code`の作業が完了し、ユーザーの入力待ちになったことをバックグラウンドのアプリに通知する。
* **設計:**
    * **トリガー:** `claude config set --global preferredNotifChannel terminal_bell` 設定を活用
    * **サーバー側:** `tmux pipe-pane`機能でセッション出力監視、BEL文字 (`\x07`) 検知
    * **通知実行:** FCM/APNS APIによるプッシュ通知送信
    * **クライアント側:** `expo-notifications`でデバイストークン管理
* **次の作業:**
    * Expo Notifications設定
    * サーバー側監視スクリプト作成
    * プッシュ通知権限・設定UI実装

### 5. データフロー

1.  **初回起動時:**
    * `app/_layout.tsx` () で接続状態をチェック。未接続なら`server-connection`画面へリダイレクト。
    * 接続情報を入力し、SSH接続を確立。成功情報を`authSlice` () に保存。
2.  **セッション操作:**
    * ユーザーのUI操作（例: 「新規作成」）に応じて、アプリはWebSocket経由で`tmux`コマンド送信をリクエスト。
    * `tmux ls`コマンドの結果を`sessionSlice`（新規作成）に保存し、UIを更新。
3.  **対話:**
    * ユーザーがターミナル画面でコマンドを入力すると、WebSocket経由でサーバーに送信。
    * WebSocket経由でサーバーから受信した出力データをリアルタイムで画面に描画する。
4.  **通知:**
    * `claude code`がBEL文字を出力 → サーバー上の監視スクリプトが検知 → FCM/APNS経由でデバイスにPush通知が届く。

### 6. 今後の課題 (MVP以降)

* **ファイルブラウザ機能:** 参照プロジェクトの`app/(tabs)/files.tsx` () のような、ワークスペース内のファイルを確認・閲覧する機能の実装。
* **高度な認証管理:** アプリ内でのSSHキーペア生成・管理UIの提供。
* **オフライン対応:** 限定的なキャッシュ機能。
* **テーマの動的切り替え:** 設定画面からのライト/ダークモード切り替え機能の実装 ()。