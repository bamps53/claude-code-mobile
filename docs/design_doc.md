## **Claude Code モバイルクライアント 設計提案書**

### 1. 概要

本ドキュメントは、リモートサーバー上で動作する`claude code`と対話するための、モバイルクライアントアプリケーションの設計を定義するものです。

開発は**TypeScript + React Native + Expo**で行い、`claude code`の特性に合わせた最適化を行います。

### 2. 背景と目的

`claude code`は強力な開発支援ツールですが、現在はデスクトップ環境での利用が主です。以下の目的を達成するため、モバイルクライアントを開発します。

* **リモートアクセスの提供:** スマートフォンから場所を問わず、リモートサーバー上の`claude code`セッションにアクセスし、タスクの指示や進捗確認を行えるようにする。
* **非同期ワークフローの実現:** `claude code`の作業が完了し、ユーザーの入力が必要になったタイミングで**Push通知**を送信することで、ユーザーは常にPC前で待機する必要がなくなります。
* **複数タスクの並行管理:** 複数の`claude code`セッションをシームレスに切り替え、複数のプロジェクトやタスクを並行して進められるようにする。

### 3. アーキテクチャ

#### 3.1. 技術スタック

参照プロジェクト () の構成はモダンで安定しているため、これを踏襲します。

| カテゴリ | 技術 | 理由 |
| :--- | :--- | :--- |
| **フレームワーク** | React Native + Expo (EAS Build) | 迅速なクロスプラットフォーム開発を実現するため。SSH接続などのネイティブ機能を利用するためにEAS(Expo Application Services)の使用を前提とします。 |
| **言語** | TypeScript | 型安全性による開発効率と品質の向上のため。 () |
| **状態管理** | Redux Toolkit | アプリケーション全体の複雑な状態（接続情報、セッションリスト、チャット履歴など）を予測可能かつ効率的に管理するため。 () |
| **画面遷移** | Expo Router | ファイルベースのルーティングにより、直感的で宣言的なナビゲーションを構築します。 () |
| **UIコンポーネント** | React Native Paper | Material Designに準拠した高品質なUIコンポーネント群により、迅速で一貫性のあるUI開発を実現します。 () |
| **API/SSH通信** | `axios` / `react-native-ssh-sftp` | HTTP通信には`axios`を利用 ()。コア機能であるSSH通信には、EAS経由で`react-native-ssh-sftp`のようなネイティブライブラリを導入します。 |
| **データ永続化** | Expo Secure Store | サーバーURLや認証情報などの機密情報を安全にデバイス内に保存します。 () |
| **Push通知** | Expo Notifications | FCM (Firebase) / APNS (Apple) を利用したPush通知を容易に実装するため。 |

#### 3.2. アプリケーション構成（ディレクトリ構造）

参照プロジェクト () の構成を参考に、以下のようなディレクトリ構造を採用します。

```
/
├── app/                  # Expo Routerによる画面定義
│   ├── (tabs)/           # メイン機能のタブ画面
│   │   ├── _layout.tsx     # タブ自体のレイアウト
│   │   ├── session.tsx     # セッション管理画面
│   │   └── terminal.tsx    # ターミナル操作画面
│   ├── _layout.tsx       # 全体のルートレイアウト
│   ├── server-connection.tsx # サーバー接続画面
│   └── settings.tsx      # 設定画面
├── src/
│   ├── api/              # API・SSH通信関連のロジック
│   ├── components/       # 共通UIコンポーネント
│   ├── hooks/            # カスタムフック
│   ├── store/            # Redux状態管理 (authSlice, sessionSlice)
│   ├── theme/            # アプリのテーマ設定 ()
│   └── utils/            # ユーティリティ関数
└── ...                   # その他設定ファイル (package.json, app.json)
```

### 4. 主要機能と画面設計

#### 4.1. サーバー接続機能

* **目的:** ユーザーが管理するリモートサーバーへのSSH接続情報を設定・保存する。
* **実装:**
    * 参照プロジェクトの `app/server-connection.tsx` () と `src/store/authSlice.ts` () のロジックを流用します。
    * 入力項目は「ホスト名」「ポート」「ユーザー名」とし、認証方法は当面「公開鍵認証」を前提とします（アプリ内でキーペアを生成し、ユーザーに公開鍵をサーバーへ登録してもらう）。
    * 接続成功時に、接続情報を`expo-secure-store`に保存します。

#### 4.2. セッション管理

* **目的:** サーバー上の複数の`claude code`セッションを管理し、切り替える。
* **実装:**
    * 参照プロジェクトの `app/(tabs)/index.tsx` () のようなリスト形式のUIを採用します。
    * UI上の「新規セッション作成」ボタンは、SSH経由で`tmux new -s <session_name> -d`コマンドを実行します。
    * セッション一覧は`tmux ls`コマンドの結果をパースして表示します。
    * ユーザーがセッションを選択すると、`tmux attach -t <session_name>`で対象セッションにアタッチします。
    * これにより、ユーザーは`tmux`を意識することなく、直感的にセッションを操作できます。

#### 4.3. ターミナル/チャット画面

* **目的:** `claude code`との主要な対話を行う画面。
* **実装:**
    * 参照プロジェクトの `app/(tabs)/terminal.tsx` () と `src/screens/ChatScreen.tsx` () を融合したUIを構築します。
    * 画面下部にコマンド入力フィールドと送信ボタンを配置します。
    * 画面の大部分は、SSHセッションの`stdout`をリアルタイムに表示するスクロールビューとします。
    * `Ctrl+C`などの特殊キーは、入力フィールド横のボタンとして提供します。

#### 4.4. Push通知

* **目的:** `claude code`の作業が完了し、ユーザーの入力待ちになったことをバックグラウンドのアプリに通知する。
* **実装:**
    * **トリガー:** `claude config set --global preferredNotifChannel terminal_bell` 設定を活用します。
    * **サーバー側:** `tmux pipe-pane`機能を利用し、セッションの出力を常時監視する軽量なスクリプトをサーバー上で実行させます。このスクリプトは、出力ストリームからターミナルベル文字 (`\x07`) を検知します。
    * **通知実行:** BEL文字を検知したスクリプトは、FCM/APNSのAPIを呼び出し、該当セッションに紐づくデバイストークン宛にPush通知を送信します。
    * **クライアント側:** アプリは`expo-notifications`を利用してデバイストークンを取得し、セッション開始時にサーバーへ送信します。

### 5. データフロー

1.  **初回起動時:**
    * `app/_layout.tsx` () で接続状態をチェック。未接続なら`server-connection`画面へリダイレクト。
    * 接続情報を入力し、SSH接続を確立。成功情報を`authSlice` () に保存。
2.  **セッション操作:**
    * ユーザーのUI操作（例: 「新規作成」）に応じて、アプリはSSH経由で`tmux`コマンドを実行。
    * `tmux ls`コマンドの結果を`sessionSlice`（新規作成）に保存し、UIを更新。
3.  **対話:**
    * ユーザーがターミナル画面でコマンドを入力すると、SSHの`stdin`に書き込む。
    * SSHの`stdout`から受信したデータをリアルタイムで画面に描画する。
4.  **通知:**
    * `claude code`がBEL文字を出力 → サーバー上の監視スクリプトが検知 → FCM/APNS経由でデバイスにPush通知が届く。

### 6. 今後の課題 (MVP以降)

* **ファイルブラウザ機能:** 参照プロジェクトの`app/(tabs)/files.tsx` () のような、ワークスペース内のファイルを確認・閲覧する機能の実装。
* **高度な認証管理:** アプリ内でのSSHキーペア生成・管理UIの提供。
* **オフライン対応:** 限定的なキャッシュ機能。
* **テーマの動的切り替え:** 設定画面からのライト/ダークモード切り替え機能の実装 ()。