# Claude Code モバイルクライアント 設計書

## 1. プロジェクト概要

### 目的
リモートサーバー上で動作する`claude code`セッションに、モバイルデバイスから安全にアクセスできるアプリケーションを開発する。

### 主要価値提案
- **場所を問わないアクセス**: スマートフォンからリモート開発環境へのアクセス
- **非同期ワークフロー**: Claude Codeの作業完了時にプッシュ通知で即座に確認
- **複数セッション管理**: 複数の開発タスクを並行して効率的に管理

## 2. 技術要件と制約

### 2.1 基本要件
- **プラットフォーム**: iOS、Android（React Native）
- **接続方式**: SSH（直接接続）
- **セッション管理**: tmux セッション
- **セキュリティ**: エンドツーエンド暗号化、認証情報のローカル暗号化保存

### 2.2 技術制約
- **ネイティブ機能要求**: SSH接続のためEAS Build必須
- **オフライン制約**: SSH接続必須のためオフライン機能限定的
- **パフォーマンス**: モバイルネットワーク環境での最適化必要

## 3. アーキテクチャ設計

### 3.1 技術スタック

| 領域 | 技術 | 選定理由 |
|------|------|----------|
| **フレームワーク** | React Native + Expo | クロスプラットフォーム開発効率 |
| **言語** | TypeScript | 型安全性と開発効率 |
| **状態管理** | Redux Toolkit | 複雑な状態の予測可能な管理 |
| **ナビゲーション** | Expo Router | ファイルベースルーティング |
| **UI ライブラリ** | React Native Paper | Material Design準拠 |
| **SSH 通信** | react-native-ssh-sftp | ネイティブSSH接続 |
| **セキュア ストレージ** | Expo Secure Store | 認証情報の暗号化保存 |
| **プッシュ通知** | Expo Notifications | FCM/APNS統合 |

### 3.2 アプリケーション構造

```
/
├── app/                     # Expo Router screens
│   ├── (tabs)/             # メインタブナビゲーション
│   │   ├── _layout.tsx     # タブレイアウト
│   │   ├── sessions.tsx    # セッション管理
│   │   └── terminal.tsx    # ターミナルインターフェース
│   ├── _layout.tsx         # ルートレイアウト
│   ├── connection.tsx      # SSH接続設定
│   └── settings.tsx        # アプリ設定
├── src/
│   ├── api/               # SSH API層
│   ├── components/        # 再利用可能コンポーネント
│   ├── hooks/            # カスタムフック
│   ├── store/            # Redux ストア
│   ├── types/            # TypeScript型定義
│   └── utils/            # ユーティリティ関数
└── assets/               # 静的リソース
```

## 4. 機能設計

### 4.1 SSH接続管理
**目的**: 安全なサーバー接続の確立と管理

**機能要件**:
- パスワード認証とSSHキー認証の両方対応
- 接続情報の暗号化保存
- 接続状態の監視と自動再接続
- 複数サーバー7への接続プロファイル管理

### 4.2 tmuxセッション管理
**目的**: リモートサーバー上のClaude Codeセッションの管理

**機能要件**:
- セッション一覧表示（作成日時、最終アクティビティ）
- 新規セッション作成
- 既存セッションへの接続・切断
- セッション削除
- セッション状態のリアルタイム更新

### 4.3 ターミナルインターフェース
**目的**: Claude Codeとの直接的なインタラクション

**機能要件**:
- リアルタイムコマンド入力・出力表示
- ターミナルエスケープシーケンス対応
- コマンド履歴機能
- 特殊キー入力（Ctrl+C、Tab、矢印キー）
- テキストサイズ調整、カラーテーマ

### 4.4 プッシュ通知システム
**目的**: Claude Code作業完了時の非同期通知

**技術設計**:
- サーバー側：tmux出力監視でBEL文字（`\x07`）検知
- 通知送信：FCM/APNS経由でリアルタイム通知
- クライアント側：バックグラウンド受信と適切なディープリンク

## 5. セキュリティ設計

### 5.1 データ保護
- **認証情報**: Expo Secure Storeでローカル暗号化
- **通信**: SSH標準暗号化プロトコル
- **セッションデータ**: メモリ内のみ、永続化なし

### 5.2 認証戦略
- **一次認証**: SSH（パスワード/キー）
- **二次認証**: アプリレベル（PIN/生体認証）
- **セッション管理**: 自動タイムアウト設定

## 6. ユーザーエクスペリエンス設計

### 6.1 画面フロー
```
起動 → 接続設定確認 → セッション一覧 → ターミナル操作
     ↓（未設定時）    ↓（新規作成）   ↓
   接続設定 ────→ セッション作成 → ターミナル操作
```

### 6.2 エラーハンドリング
- **ネットワークエラー**: 自動再試行とユーザー通知
- **認証エラー**: 明確なエラーメッセージと再設定フロー
- **セッションエラー**: グレースフルな復旧とフォールバック

## 7. パフォーマンス要件

### 7.1 応答性
- 接続確立：5秒以内
- コマンド応答：1秒以内（通常時）
- セッション切り替え：即座

### 7.2 リソース使用量
- メモリ使用量：100MB以下（通常時）
- バッテリー消費：最小限（効率的な接続管理）
- データ使用量：テキストベースで最小限

## 8. 品質保証

### 8.1 テスト戦略
- **単体テスト**: 重要なロジック（SSH接続、状態管理）
- **統合テスト**: SSH接続からターミナル操作まで
- **E2Eテスト**: 主要ユーザーフローの自動化
- **セキュリティテスト**: 認証情報保護の検証

### 8.2 監視・ログ
- **エラー追跡**: クラッシュレポートと詳細ログ
- **パフォーマンス監視**: 接続品質とレスポンス時間
- **使用分析**: 機能使用率とユーザー行動パターン

## 9. 拡張性・保守性

### 9.1 将来の機能拡張
- SFTP ファイル転送機能
- 複数ターミナルタブ
- SSH トンネリング機能
- カスタムキーバインディング

### 9.2 保守性
- **コード品質**: ESLint、Prettier、TypeScript strict mode
- **ドキュメント**: 機能仕様とAPI仕様の維持
- **依存関係管理**: 定期的なセキュリティアップデート

---

このドキュメントは開発フェーズに応じて更新され、実装の進捗と合わせて詳細化されます。